Run command on Linux with resources limited.

!https://api.travis-ci.org/quark-zju/lrun.png!:https://travis-ci.org/quark-zju/lrun

h1. Dependencies

h2. Running dependencies

* *linux*: kernel >= 2.6.26. you can check kernel config by @utils/check_linux_config.rb@.
* *libseccomp*: (optionally) to enable syscall filtering feature.

h2. Building dependencies

* *g++*: g++ 4.6 and above recommended, 4.4 should work as well. Or clang++
* *install*: to install binaries.
* *pkg-config*: to get information about libseccomp.
* *groupadd*: to create @lrun@ group.
* *sudo*: (optionally) to install via a non-root user.

h1. Installation

h2. Build from source

<pre>
cd src
rake install
</pre>

h3. User permissions

@lrun@ requires @root@ permission. It can do very powerful/dangerous things.

Normal users should use @sudo@ to run lrun properly.
If you want to run @lrun@ using a trusted non-root user without @sudo@, add that user to @lrun@ group.

h3. Building options

There are several environment variables which can affect building process:

* *PREFIX*: Install destination. Default is @/usr/local@.
* *CXX*: The C++ compiler. For example, @clang++@ or @g++@
* *CXXFLAGS*: Flags used for C++ compiler. Default is @-O2 -Wall@
* *LD*: The linker. Default is the same as @CXX@.
* *INSTALL*: @install@ binary.
* *LRUN_GROUP*: The group which have access to run lrun directly. Default is @lrun@.

h2. Archlinux

Archlinux users can install lrun from AUR:

<pre>
yaourt -S lrun
</pre>


h1. Usage

<pre>lrun --help</pre>

h1. Examples

h2. Limit time

<pre>
% lrun --max-cpu-time 1.5 bash -c ':(){ :;};:' 3>&1
MEMORY   10461184
CPUTIME  1.500
REALTIME 1.507
SIGNALED 0
EXITCODE 0
TERMSIG  0
EXCEED   CPU_TIME
</pre>

<pre>
% lrun --max-real-time 1.0 sleep 2 3>&1
MEMORY   393216
CPUTIME  0.001
REALTIME 1.000
SIGNALED 0
EXITCODE 0
TERMSIG  0
EXCEED   REAL_TIME
</pre>

h2. Limit memory

<pre>
% lrun --max-memory 1000000 gedit 3>&1
MEMORY   1000000
CPUTIME  0.003
REALTIME 0.020
SIGNALED 0
EXITCODE 0
TERMSIG  0
EXCEED   MEMORY
</pre>

h2. Restrict network

<pre>
% lrun --network true /sbin/ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue state UNKNOWN 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: wlan0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP qlen 1000
    link/ether 00:26:82:af:cf:75 brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.3/24 brd 192.168.1.255 scope global wlan0
    inet6 fe80::226:82ff:feaf:cf75/64 scope link 
       valid_lft forever preferred_lft forever

% lrun --network false /sbin/ip addr
205: lo: <LOOPBACK> mtu 16436 qdisc noop state DOWN 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</pre>

h2. Isolate processes

<pre>
% lrun --isolate-process false bash -c 'echo $$'
10140

% lrun --isolate-process true bash -c 'echo $$'
1
</pre>

h2. Change uid

<pre>
% lrun --uid 2000 /usr/bin/sudo ls
sudo: unknown uid 2000: who are you?
</pre>

h2. Mount tmpfs

<pre>
% lrun ls /usr
NX  bin  i486-mingw32  include	lib  lib32  local  man	sbin  share  src  x86_64-unknown-linux-gnu

% lrun --tmpfs /var 40960 df /var
Filesystem     1K-blocks  Used Available Use% Mounted on
none                  40     0        40   0% /usr

% lrun --tmpfs /tmp 0 touch /tmp/abc 3>&1
touch: cannot touch `/tmp/abc': Read-only file system
MEMORY   262144
CPUTIME  0.001
REALTIME 0.090
SIGNALED 0
EXITCODE 1
TERMSIG  0
EXCEED   none
</pre>

h2. Syscall filter

This requires kernel >= 3.5 and libseccomp (at both compile and run time).

<pre>
% lrun readlink /lib
usr/lib
</pre>

<pre>
% lrun --syscalls '!readlink' readlink /lib 3>&1
MEMORY   262144
CPUTIME  0.000
REALTIME 0.070
SIGNALED 0
EXITCODE 1
TERMSIG  0
EXCEED   none
</pre>

h2. Realtime status

Use `--status` to show realtime cpu, memory usage information:

<pre>
% lrun --status firefox
</pre>

h1. Utilities

There are some related utilities in @utils@ directory. You may find some of them helpful.

h1. Troubleshooting

*Error: "FATAL: can not mount cgroup memory on '/sys/fs/cgroup/memory' (No such file or directory)"*

You may be using Debian. Memory controller is compiled but deactivated. Try adding @cgroup_enable=memory@ as a kernel parameter.
When using grub2, this can be done by editing @GRUB_CMDLINE_LINUX@ in @/etc/default/grub@ and running @update-grub2@.

